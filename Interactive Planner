#include <SFML/Graphics.hpp>
#include <iostream>
#include <vector>
#include <ctime>
#include <sstream>
#include <iomanip>
#include <map>

// Helper function to get the week's dates based on an offset (weeks ahead or behind)
std::vector<std::string> getWeekDates(int weekOffset) {
    std::vector<std::string> daysWithDates(7);

    std::time_t now = std::time(nullptr);
    std::tm currentTime = *std::localtime(&now);

    // Calculate the offset to the current week's starting day (Monday)
    int dayOffset = currentTime.tm_wday == 0 ? -6 : 1 - currentTime.tm_wday;

    // Move the start of the week forward or backward based on the weekOffset
    currentTime.tm_mday += (weekOffset * 7); // Offset by weekOffset weeks
    std::mktime(&currentTime);

    // Loop through the days of the week
    for (int i = 0; i < 7; ++i) {
        std::tm dayTime = currentTime;
        dayTime.tm_mday += dayOffset + i;
        std::mktime(&dayTime);

        std::ostringstream oss;
        oss << std::put_time(&dayTime, "%b %d");
        daysWithDates[i] = oss.str();
    }

    return daysWithDates;
}



int main() {
    const int windowWidth = 850;
    const int windowHeight = 500;

    sf::RenderWindow window(sf::VideoMode(windowWidth, windowHeight), "Interactive Weekly Planner");

    sf::Texture plannerTexture;
    if (!plannerTexture.loadFromFile("/Users/absfolder/Desktop/planner.jpg")) {
        std::cerr << "Error: Failed to load planner image.\n";
        return -1;
    }

    sf::Sprite plannerSprite;
    plannerSprite.setTexture(plannerTexture);

    sf::Vector2u textureSize = plannerTexture.getSize();
    plannerSprite.setScale(
        static_cast<float>(windowWidth) / textureSize.x,
        static_cast<float>(windowHeight) / textureSize.y
    );

    sf::Font font;
    if (!font.loadFromFile("/System/Library/Fonts/Supplemental/Arial.ttf")) {
        std::cerr << "Error: Failed to load font.\n";
        return -1;
    }

    int weekOffset = 0;  // Keeps track of the current week offset
    std::vector<std::string> weekDates = getWeekDates(weekOffset);

    sf::Text dateText;
    dateText.setFont(font);
    dateText.setCharacterSize(15);
    dateText.setFillColor(sf::Color::Black);

    sf::Vector2f positions[] = {
        {380.f, 69.f}, {575.f, 69.f}, {770.f, 69.f},
        {380.f, 267.f}, {575.f, 267.f}, {770.f, 267.f}, {770.f, 365.f}
    };

    // Use a map to store tasks for each week (key is the week offset)
    std::map<int, std::vector<std::vector<std::string>>> weekTasks;

    // Initialize the map for the current week
    weekTasks[weekOffset] = std::vector<std::vector<std::string>>(7);

    sf::Text taskText;
    taskText.setFont(font);
    taskText.setCharacterSize(12);
    taskText.setFillColor(sf::Color::Black);

    // Input box and text
    sf::RectangleShape inputBox(sf::Vector2f(200.f, 30.f));
    inputBox.setFillColor(sf::Color(200, 200, 200));
    inputBox.setOutlineThickness(2.f);
    inputBox.setOutlineColor(sf::Color::Black);
    inputBox.setPosition(400.f, 30.f);

    sf::Text inputText;
    inputText.setFont(font);
    inputText.setCharacterSize(15);
    inputText.setFillColor(sf::Color::Black);
    inputText.setPosition(inputBox.getPosition() + sf::Vector2f(5.f, 5.f));

    std::string userInput = "";
    int selectedDay = -1;
    bool generalTaskSelected = false;

    // General tasks data
    sf::Text generalTaskText;
    generalTaskText.setFont(font);
    generalTaskText.setCharacterSize(12);
    generalTaskText.setFillColor(sf::Color::Blue);

    std::vector<std::string> generalTasks;

    // Define where to render general tasks on the left
    float generalTaskStartX = 50.f; // X-coordinate for the left side
    float generalTaskStartY = 90.f; // Starting Y-coordinate for tasks
    float generalTaskSpacing = 18.f; // Spacing between tasks

    while (window.isOpen()) {
        sf::Event event;
        while (window.pollEvent(event)) {
            if (event.type == sf::Event::Closed)
                window.close();

            if (event.type == sf::Event::MouseButtonPressed && event.mouseButton.button == sf::Mouse::Left) {
                sf::Vector2i mousePos = sf::Mouse::getPosition(window);

                // Check if clicking in the general task area
                if (mousePos.x >= 20.f && mousePos.x <= 200.f && mousePos.y >= 50.f && mousePos.y <= 450.f) {
                    generalTaskSelected = true;
                    selectedDay = -1;
                } else {
                    generalTaskSelected = false;

                    for (int i = 0; i < 7; ++i) {
                        sf::FloatRect boxBounds(positions[i], {150.f, 50.f});
                        if (boxBounds.contains(static_cast<sf::Vector2f>(mousePos))) {
                            selectedDay = i;
                            generalTaskSelected = false;
                        }
                    }
                }
            }

            // Handle text input
            if (event.type == sf::Event::TextEntered) {
                if (event.text.unicode == '\b') { // Handle backspace
                    if (!userInput.empty())
                        userInput.pop_back();
                } else if (event.text.unicode == '\r' || event.text.unicode == '\n') { // Handle Enter
                    if (generalTaskSelected && !userInput.empty()) {
                        generalTasks.push_back(userInput);
                        userInput.clear();
                    } else if (selectedDay != -1 && !userInput.empty()) {
                        weekTasks[weekOffset][selectedDay].push_back(userInput);
                        userInput.clear();
                    }
                } else if (event.text.unicode < 128) { // Append regular characters
                    userInput += static_cast<char>(event.text.unicode);
                }
            }

            // Handle arrow keys to switch weeks
            if (event.type == sf::Event::KeyPressed) {
                if (event.key.code == sf::Keyboard::Left) {  // Go to previous week
                    weekOffset--;
                    weekDates = getWeekDates(weekOffset);
                    if (weekTasks.find(weekOffset) == weekTasks.end()) {
                        weekTasks[weekOffset] = std::vector<std::vector<std::string>>(7);  // Initialize new week
                    }
                } else if (event.key.code == sf::Keyboard::Right) {  // Go to next week
                    weekOffset++;
                    weekDates = getWeekDates(weekOffset);
                    if (weekTasks.find(weekOffset) == weekTasks.end()) {
                        weekTasks[weekOffset] = std::vector<std::vector<std::string>>(7);  // Initialize new week
                    }
                }
            }
        }
        
        

        inputText.setString(userInput);

        window.clear();
        window.draw(plannerSprite);

        // Draw general tasks
        float taskY = generalTaskStartY;
        for (const auto &task : generalTasks) {
            generalTaskText.setString(task);
            generalTaskText.setPosition(generalTaskStartX, taskY);
            window.draw(generalTaskText);
            taskY += generalTaskSpacing;
        }

        // Draw weekly planner
        for (int i = 0; i < 7; ++i) {
            dateText.setString(weekDates[i]);
            dateText.setPosition(positions[i]);
            window.draw(dateText);

            float taskY = positions[i].y + 20.f;
            float taskX = positions[i].x - 140.f;
            for (const auto &task : weekTasks[weekOffset][i]) {
                taskText.setString(task);
                taskText.setPosition(taskX, taskY);
                window.draw(taskText);
                taskY += 15.f;
            }
        }

        // Draw input box and text
        if (selectedDay != -1 || generalTaskSelected) {
            window.draw(inputBox);
            window.draw(inputText);
        }

        window.display();
    }

    return 0;
}
